<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.19a4c6a8422e508d36e4.css">@font-face{font-family:House Slant;src:url(/static/HouseSlant-9a6c3f9affa2e83921fe363d3a98cf1d.eot);src:url(/static/HouseSlant-9a6c3f9affa2e83921fe363d3a98cf1d.eot?#iefix) format("embedded-opentype"),url(/static/HouseSlant-b17c2393a27f75a9ddc8dfe9c1525942.woff) format("woff");font-style:normal;font-weight:400;font-stretch:normal;font-display:swap}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}a{background-color:transparent}strong{font-weight:bolder}code{font-family:monospace,monospace;font-size:1em}small{font-size:80%}button,input{font-family:inherit;font-size:100%;line-height:1.15;margin:0;overflow:visible}button{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}legend{color:inherit;display:table;max-width:100%;white-space:normal}[type=checkbox],[type=radio],legend{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}[hidden]{display:none}html{box-sizing:border-box;font-family:sans-serif}*,:after,:before{box-sizing:inherit}figure,h1,h2,h3,p{margin:0}button{background:transparent;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}ul{list-style:none;margin:0;padding:0}html{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}*,:after,:before{border:0 solid #e2e8f0}input::placeholder{color:#a0aec0}[role=button],button{cursor:pointer}h1,h2,h3{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input{padding:0;line-height:inherit;color:inherit}canvas,object,svg{display:block;vertical-align:middle}body{min-height:100vh}.font-slant{font-family:House Slant,sans-serif}code{background-color:#4a5568;color:#fff;display:inline-block;padding-left:.5rem;padding-right:.5rem;border-radius:.25rem;font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-weight:700}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:960px){.container{max-width:960px}}.bg-gray-100{background-color:#f7fafc}.bg-gray-900{background-color:#1a202c}.border-gray-300{border-color:#e2e8f0}.focus\:border-gray-500:focus{border-color:#a0aec0}.rounded{border-radius:.25rem}.rounded-lg{border-radius:.5rem}.border{border-width:1px}.border-t{border-top-width:1px}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.flex-col{flex-direction:column}.items-center{align-items:center}.items-baseline{align-items:baseline}.justify-center{justify-content:center}.flex-1{flex:1 1 0%}.flex-grow{flex-grow:1}.font-mono{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.font-bold{font-weight:700}.h-6{height:1.5rem}.h-8{height:2rem}.leading-none{line-height:1}.leading-snug{line-height:1.375}.leading-normal{line-height:1.5}.list-disc{list-style-type:disc}.mx-1{margin-left:.25rem;margin-right:.25rem}.my-2{margin-top:.5rem;margin-bottom:.5rem}.mx-2{margin-left:.5rem;margin-right:.5rem}.my-4{margin-top:1rem;margin-bottom:1rem}.my-8{margin-top:2rem;margin-bottom:2rem}.my-12{margin-top:3rem;margin-bottom:3rem}.mx-auto{margin-left:auto;margin-right:auto}.-mx-1{margin-left:-.25rem;margin-right:-.25rem}.-mx-2{margin-left:-.5rem;margin-right:-.5rem}.mb-1{margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mt-4{margin-top:1rem}.mr-4{margin-right:1rem}.mb-6{margin-bottom:1.5rem}.ml-6{margin-left:1.5rem}.mb-8{margin-bottom:2rem}.ml-auto{margin-left:auto}.min-h-screen{min-height:100vh}.opacity-75{opacity:.75}.hover\:opacity-100:hover{opacity:1}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.overflow-x-hidden{overflow-x:hidden}.p-2{padding:.5rem}.p-4{padding:1rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pt-2{padding-top:.5rem}.pt-6{padding-top:1.5rem}.pb-12{padding-bottom:3rem}.fill-current{fill:currentColor}.text-center{text-align:center}.text-white{color:#fff}.text-gray-600{color:#718096}.text-gray-700{color:#4a5568}.text-gray-800{color:#2d3748}.text-gray-900{color:#1a202c}.hover\:text-black:hover{color:#000}.group:hover .group-hover\:text-blue-700{color:#2b6cb0}.text-sm{font-size:.875rem}.text-base{font-size:1rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.text-5xl{font-size:3rem}.underline{text-decoration:underline}.no-underline{text-decoration:none}.group:hover .group-hover\:underline,.hover\:underline:hover{text-decoration:underline}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.tracking-wider{letter-spacing:.05em}.whitespace-no-wrap{white-space:nowrap}.w-6{width:1.5rem}.w-8{width:2rem}.w-full{width:100%}.transition{transition-duration:.25s;transition-property:all;transition-timing-function:ease-in-out;transition-delay:.1s}.shadow-overflow-y{background:linear-gradient(#fff 30%,hsla(0,0%,100%,0)),linear-gradient(hsla(0,0%,100%,0),#fff 70%) 0 100%,radial-gradient(farthest-side at 50% 0,rgba(0,0,0,.2),transparent),radial-gradient(farthest-side at 50% 100%,rgba(0,0,0,.2),transparent) 0 100%;background-repeat:no-repeat;background-color:#fff;background-size:100% 40px,100% 40px,100% 14px,100% 14px;background-attachment:local,local,scroll,scroll}@media (min-width:960px){.lg\:flex{display:flex}.lg\:h-12{height:3rem}.lg\:h-screen{height:100vh}.lg\:-my-4{margin-top:-1rem;margin-bottom:-1rem}.lg\:-mr-4{margin-right:-1rem}.lg\:opacity-50{opacity:.5}.lg\:py-8{padding-top:2rem;padding-bottom:2rem}.lg\:pr-4{padding-right:1rem}.lg\:pl-12{padding-left:3rem}.lg\:sticky{position:sticky}.lg\:top-0{top:0}.lg\:text-2xl{font-size:1.5rem}.lg\:text-3xl{font-size:1.875rem}.lg\:text-6xl{font-size:4rem}.lg\:w-12{width:3rem}}</style><meta name="generator" content="Gatsby 2.17.4"/><title data-react-helmet="true">Tuning dynamic php-fpm settings - Chris Morrell | Chris Morrell</title><meta data-react-helmet="true" name="description" content="The personal website of Chris Morrell."/><meta data-react-helmet="true" property="og:title" content="Tuning dynamic php-fpm settings - Chris Morrell"/><meta data-react-helmet="true" property="og:description" content="The personal website of Chris Morrell."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@inxilpro"/><meta data-react-helmet="true" name="twitter:title" content="Tuning dynamic php-fpm settings - Chris Morrell"/><meta data-react-helmet="true" name="twitter:description" content="The personal website of Chris Morrell."/><link rel="shortcut icon" href="/icons/icon-48x48.png?v=a6aa42d67a66709899f0ff2e15e76b29"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#424957"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a6aa42d67a66709899f0ff2e15e76b29"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a6aa42d67a66709899f0ff2e15e76b29"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a6aa42d67a66709899f0ff2e15e76b29"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a6aa42d67a66709899f0ff2e15e76b29"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a6aa42d67a66709899f0ff2e15e76b29"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a6aa42d67a66709899f0ff2e15e76b29"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a6aa42d67a66709899f0ff2e15e76b29"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a6aa42d67a66709899f0ff2e15e76b29"/><link as="script" rel="preload" href="/styles-3bf00d661f72bc0ac4fe.js"/><link as="script" rel="preload" href="/component---src-pages-php-fpm-js-0bcf9534661e07e554a9.js"/><link as="script" rel="preload" href="/commons-34709ad0b73a77f7ef2c.js"/><link as="script" rel="preload" href="/app-89306f7c75de653da317.js"/><link as="script" rel="preload" href="/webpack-runtime-b5695532f7927d2678f8.js"/><link as="fetch" rel="preload" href="/page-data/php-fpm/page-data.json" crossorigin="anonymous"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div class="flex flex-col min-h-screen antialiased"><header class="bg-gray-900 text-white"><div class="container mx-auto p-4 flex items-center"><h1 style="margin:0"><a class="text-white hover:underline" href="/">Chris Morrell</a></h1><div class="ml-auto flex -mx-1"><a class="mx-1 no-underline opacity-75 hover:opacity-100" href="https://twitter.com/inxilpro" target="_blank" rel="noopener noreferrer" title="Chris Morrell on Twitter"><svg class="h-6 w-6 fill-current" role="img" viewBox="0 0 24 24"><title>Twitter icon</title><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"></path></svg></a><a class="mx-1 no-underline opacity-75 hover:opacity-100" href="https://github.com/inxilpro/" target="_blank" rel="noopener noreferrer" title="Chris Morrell on Github"><svg class="h-6 w-6 fill-current" role="img" viewBox="0 0 24 24"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></div></div></header><main class="flex-1"><div class="container mx-auto p-4"><h1 class="text-5xl lg:text-6xl font-bold font-slant text-gray-800">Tuning dynamic php-fpm settings</h1><p class="text-xl lg:text-2xl leading-normal my-4">This is as much a note to self than anything else. Each time I need to change my <code>php-fpm</code> settings, I need to Google “php-fpm dynamic tuning” or something similar. With a little luck, next time I Google it, I&#x27;ll find this page :)</p><h2 class="text-xl lg:text-3xl font-bold font-slant my-4">Step one: Figuring out how much memory your typical PHP process uses</h2><p class="text-xl leading-normal my-4">First we need to figure out how much memory a typical PHP process uses. This will inform the total number of processes that we’re going to run. We can do that with this nifty command:</p><p class="my-4"><code>ps --no-headers -o &quot;rss,cmd&quot; -C php-fpm | awk &#x27;{ sum+=$1 } END { printf (&quot;%d%s\n&quot;, sum/NR/1024,&quot;M&quot;) }&#x27;</code></p><p class="text-xl leading-normal my-4">The <code>ps</code> bit will show all the current running <code>php-fpm</code> processes (including their memory consumption), and then the <code>awk</code> bit adds them all up and pretty-prints the value in MB.</p><p class="text-xl leading-normal my-4">In the end, this will print out a nice number for us. Something in the <strong>40–60 MB range</strong> is to be expected with a typical Laravel app.</p><h2 class="text-xl lg:text-3xl font-bold font-slant my-4">Step two: Deciding how much memory to give to PHP</h2><p class="text-xl leading-normal my-4">This one is entirely up to you. You want to leave some memory for the other processes on your server. If the server is dedicated to running PHP only, you can dedicate most of your RAM to the php-fpm processes. On the other hand, if you’re also running a database server, redis, etc, you’re going to need to leave space for those to run.</p><p class="text-xl leading-normal my-4">Keep in mind that if you have queue workers running on your server, they&#x27;ll each take up about the same amount of RAM as your other PHP processes. So, for example, if you have 10 queue workers running on your server and your processes take about 50 MB or RAM, that&#x27;s another 500 MB of RAM that you need to set aside.</p><p class="text-xl leading-normal my-4">In my most recent case, I needed to account for the fact that sometimes we have other processes running that consume about 1 GB of RAM. To play it safe, I decided to reserve 2 GB of RAM for “system and other” processes. On a instance with 8 GB of RAM, <strong>that leaves us with 6 GB for PHP</strong>.</p><h2 class="text-xl lg:text-3xl font-bold font-slant my-4">Now, let&#x27;s let the computers do math for us:</h2><div class="my-4 border rounded p-4"><div class="lg:flex -mx-2"><div class="mb-2 flex-1 flex flex-col justify-center mx-2 border rounded"><label class="font-bold mb-1 bg-gray-100 text-center p-2">Total RAM:</label><div class="flex justify-center items-baseline p-2 -mx-1"><input type="number" class="border border-gray-300 p-2 rounded focus:border-gray-500 mx-1" min="0" step=".5" value="8"/><span class="mx-1 font-bold">GB</span></div></div><div class="mb-2 flex-1 flex flex-col justify-center mx-2 border rounded"><label class="font-bold mb-1 bg-gray-100 text-center p-2">Reserved RAM:</label><div class="flex justify-center items-baseline p-2 -mx-1"><input type="number" class="border border-gray-300 p-2 rounded focus:border-gray-500 mx-1" min="0" step=".5" value="2"/><span class="mx-1 font-bold">GB</span></div></div><div class="mb-2 flex-1 flex flex-col justify-center mx-2 border rounded"><label class="font-bold mb-1 bg-gray-100 text-center p-2">Average php-fpm process:</label><div class="flex justify-center items-baseline p-2 -mx-1"><input type="number" class="border border-gray-300 p-2 rounded focus:border-gray-500 mx-1" min="0" step=".5" value="60"/><span class="mx-1 font-bold">MB</span></div></div></div><div class="pt-2"><h3 class="font-bold mb-1">Suggested Settings:</h3><div class="bg-gray-100 p-2 rounded mt-4 border text-sm overflow-x-auto w-full"><div class="text-gray-600 font-mono whitespace-no-wrap">; Run php-fpm in &quot;dynamic&quot; mode</div><div class="text-gray-900 font-mono whitespace-no-wrap">pm = <strong>dynamic</strong></div><div class="my-4"></div><div class="text-gray-600 font-mono whitespace-no-wrap">; Set max_children to ([total RAM - reserved RAM]) / [average php-fpm process])</div><div class="text-gray-600 font-mono whitespace-no-wrap">; Most recently: (1024 * (<!-- -->8<!-- --> - <!-- -->2<!-- -->)) / <!-- -->60<!-- --> = <!-- -->102</div><div class="text-gray-900 font-mono whitespace-no-wrap">pm.max_children = <strong>100</strong></div><div class="my-4"></div><div class="text-gray-600 font-mono whitespace-no-wrap">; When php-fpm starts, have this many processes waiting for requests. Set to 50% of</div><div class="text-gray-600 font-mono whitespace-no-wrap">; max on a server that&#x27;s mostly responsible for running PHP processes</div><div class="text-gray-900 font-mono whitespace-no-wrap">pm.start_servers = <strong>50</strong></div><div class="my-4"></div><div class="text-gray-600 font-mono whitespace-no-wrap">; Minimum number spare processes php-fpm will create. In the case of a</div><div class="text-gray-600 font-mono whitespace-no-wrap">; server dedicated to running PHP, we&#x27;ll set this to the same as start_servers</div><div class="text-gray-900 font-mono whitespace-no-wrap">pm.min_spare_servers = <strong>50</strong></div><div class="my-4"></div><div class="text-gray-600 font-mono whitespace-no-wrap">; Maximum number spare processes php-fpm will create. If more than this</div><div class="text-gray-600 font-mono whitespace-no-wrap">; many processes are idle, some will be killed.</div><div class="text-gray-900 font-mono whitespace-no-wrap">pm.max_spare_servers = <strong>75</strong></div><div class="my-4"></div><div class="text-gray-600 font-mono whitespace-no-wrap">; After this many requests, a php-fpm process will respawn. This is useful</div><div class="text-gray-600 font-mono whitespace-no-wrap">; to guard against memory leaks, but causes a small performance hit. Set to</div><div class="text-gray-600 font-mono whitespace-no-wrap">; a high number (or 0) if you&#x27;re confident that your app does not have any</div><div class="text-gray-600 font-mono whitespace-no-wrap">; memory leaks (and that you&#x27;re not using any 3rd-party libraries that have</div><div class="text-gray-600 font-mono whitespace-no-wrap">; memory leaks), or set to a lower number if you&#x27;re aware of a leak.</div><div class="text-gray-900 font-mono whitespace-no-wrap">pm.max_requests = <strong>500</strong></div></div></div></div></div></main><footer class="bg-gray-100"><div class="container mx-auto p-4 py-8 pb-12 text-sm text-gray-700">© <!-- -->2020<!-- --> Chris Morrell</div></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/php-fpm/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-89306f7c75de653da317.js"],"component---src-pages-js":["/component---src-pages-js-ca9574d8fb6db3b9f4a7.js"],"component---src-pages-404-js":["/component---src-pages-404-js-3a07c599d61fb9682793.js"],"component---src-pages-index-js":["/component---src-pages-index-js-c75eea1bf9ea5bd07871.js"],"component---src-pages-php-fpm-js":["/component---src-pages-php-fpm-js-0bcf9534661e07e554a9.js"]};/*]]>*/</script><script src="/webpack-runtime-b5695532f7927d2678f8.js" async=""></script><script src="/app-89306f7c75de653da317.js" async=""></script><script src="/commons-34709ad0b73a77f7ef2c.js" async=""></script><script src="/component---src-pages-php-fpm-js-0bcf9534661e07e554a9.js" async=""></script><script src="/styles-3bf00d661f72bc0ac4fe.js" async=""></script></body></html>